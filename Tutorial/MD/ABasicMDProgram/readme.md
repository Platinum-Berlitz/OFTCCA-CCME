# README

本程序是一个实现了最简单功能（最简单的功能已经完工了）的分子动力学程序。

## Theory

分子动力学程序的主要任务是积分离散化的演化方程，并从中提取需要的信息。系统的演化方程可以写成牛顿方程的形式:

$$
\vec{F} = m\ddot{\vec{x}}
$$

一部分系统的演化也可以以哈密顿正则形式表述：

$$
\left\{
\begin{aligned}
\dot{\vec{x}}&=\frac{\partial H}{\partial\vec{p}} \\
\dot{\vec{p}}&=-\frac{\partial H}{\partial\vec{x}}
\end{aligned}    
\right.
$$

将上述方程离散化，就可以据之实现对运动方程的积分。对积分得到的轨迹进行处理就可以产生我们想要利用分子动力学得到的物理信息。

### 不同的离散化方案举例

#### 1. Euler方法

$$
x(t+dt) = x(t) + v(t)dt + o(dt^2)\\
v(t+dt) = v(t) + \frac{F(t)}{m}dt + o(dt^2)
$$

欧拉方法是最简单的分子动力学方法，要求的信息最少，短时的表现尚可，但是并不保哈密顿，长时间会产生能量漂移。

#### 2. Verlet方法

$$
x(t+dt) = 2x(t) - x(t-dt) + \frac{F(t)}{m}dt^2 + o(dt^4)\\
v(t) = \frac{x(t+dt)-x(t-dt)}{2mdt}+o(dt^2)
$$

Verlet方法是很常用的一种动力学方法，计算流程如下：

- 计算F(t)
- 根据F(t)和x(t)以及x(t-dt)计算x(t+dt)
- 计算v(t)
- 继续下一个循环

Verlet方法的短时表现尚可，长时间能量漂移不明显，有一个能量量纲的守恒量（准哈密顿量）。

#### 3. Velocity-Verlet

$$
x(t+dt) = x(t) + v(t)dt + F(t)dt^2/2m + o(dt^3) \\
v(t+dt) = v(t) + \frac{F(t) + F(t-dt)}{2m}dt + o(dt^2)
$$

Velocity-Verlet和Verlet算法等价。

其他的如Leap-frog方法和高阶方法等省略不提。

## 程序结构

.h为头文件（接口），.c为源文件（具体实现）。程序入口（主函数）为main.c。

```c
#include "def.h"
#include "input.h"
#include "init.h"
#include "tool.h"
#include "measure.h"
#include "energy.h"
#include "integrate.h"

int main(void) {
    readInput();    // 从标准输入中读取参数

    memAlloc();     // 分配内存，以及初始化常量
    RANDINIT;       // 将时间设为随机数种子
    init();         // 初始化坐标和速度向量

    // 平衡部分
    for(int i = 0; i < bstep * cpstep; i++) {
        Integrate();    // 使用待定的方法积分
    }
    
    for(int i = 0; i < nstep; i++) {
        for(int j = 0; j < cpstep; j++) {
            Integrate();
        }
        sample();       // 采样，这里只输出动能、势能和总能量
    }

    memFree();          // 释放内存
    return 0;
}
```

### def.h和def.c

该文件规定了一些全局变量，需要用到的标准库以及一些自定义宏。文件的部分已经被删除了，因为作者认为用户应该可以看注释，这个注释似乎还是满良心的。

### input

定义了读取输入的函数readInput()，示例输入如1.in，对应读入的参数意义请见input.c和def.h的注释。

### energy

定义了力的计算和能量，通过选择注释掉某个部分可以切换lj势/谐振子势（见文件）。对于lj势能，实际采取的是截断-平移的势能(tr-sh Leonard-Jones potential)。谐振子势为中心在空间中央的，频率为1的谐振子模型。

### integrate

实现了Leap Frog， Verlet，velocity Verlet和Euler方法。

### measure

只是简单的打印输出。输出文件前半部分已经说得很详细了，后半部分如下所示：

```c
 0.000013	 0.125000	 0.125013
 0.000050	 0.125000	 0.125050
 0.000112	 0.124975	 0.125087
 0.000200	 0.124925	 0.125125
 0.000312	 0.124850	 0.125162
 0.000450	 0.124750	 0.125200
 0.000612	 0.124625	 0.125237
 0.000799	 0.124476	 0.125275
 0.001011	 0.124301	 0.125312
 0.001247	 0.124102	 0.125349
 0.001508	 0.123878	 0.125386
 0.001793	 0.123630	 0.125423
 0.002103	 0.123357	 0.125460
 0.002437	 0.123059	 0.125497
 0.002795	 0.122738	 0.125533
 0.003178	 0.122392	 0.125570
 0.003584	 0.122022	 0.125606
 0.004013	 0.121629	 0.125642
 0.004467	 0.121212	 0.125678
 0.004943	 0.120771	 0.125714
 0.005443	 0.120307	 0.125750
 0.005966	 0.119820	 0.125786
 0.006511	 0.119310	 0.125821
 0.007079	 0.118777	 0.125856
```

分别对应着（平均，下同）动能、势能和总能。

### tool

一些辅助工具。

## run中的其他文件

- compile.bat含有编译的gcc命令，会输出md.exe
- run.bat为运行的批处理文件，运行时需要更改输入、输出文件，格式如下：

```
md.exe < 输入文件名 > 输出文件名
```

- ~~plot.py会输出两个图。第一个图为三种能量随着采样步长的变化，而第二个散点图为动能-势能图，都用于检查能量的漂移程度。~~plot.py基于matplotlib，linenu为跳过的行数，steps为读取的行数。
- 对于github上的版本，在根目录下运行$make可以生成可执行文件md。

## 联系方式

Author: 蘑菇  
Mailto: uxie@pku.edu.cn

## 下一步

根据自己的练习情况还会加东西，参考Understanding Molecular Simulation这本书。另外thermostat已经实现了，只是不在这个电脑上（悲）。另外如果可能的话可能会给一个输入种子的功能？
